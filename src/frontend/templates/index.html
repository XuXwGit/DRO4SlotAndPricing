<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DRO 舱位定价模型可视化控制台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="hero position-relative">
    <div class="container py-5 text-center text-white">
        <h1 class="display-6 fw-semibold mb-3">班轮舱位分配与定价 · 可视化运行面板</h1>
        <p class="lead mb-0 text-white-50">灵活调整模型参数，实时查看优化日志与关键指标，助力更聪明的收益管理决策。</p>
    </div>
</div>

<main class="container pb-5">
    <div class="row justify-content-center g-4">
        <div class="col-12 col-xl-10">
            {% if errors %}
                <div class="alert alert-danger shadow-sm" role="alert">
                    <div class="d-flex align-items-start gap-2">
                        <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                        <div>
                            <h2 class="h6 mb-2">提交存在以下问题：</h2>
                            <ul class="mb-0 ps-3">
                                {% for error in errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}

            <section class="card glass-card border-0 shadow-sm">
                <div class="card-header border-0 bg-transparent px-4 pt-4 pb-0">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                        <div>
                            <h2 class="h4 mb-1">模型参数配置</h2>
                            <p class="text-muted mb-0 small">选择模型类型与数据来源，补充参数后即可运行优化求解。</p>
                        </div>
                        <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis px-3 py-2">实时日志已开启</span>
                    </div>
                </div>
                <div class="card-body px-4 pb-4">
                    <form method="post" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">模型类型</label>
                            <select class="form-select" name="model_type">
                                {% for value, label in model_types %}
                                    <option value="{{ value }}" {% if form_values.model_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">数据来源</label>
                            <select class="form-select" name="data_source">
                                {% for value, label in data_sources %}
                                    <option value="{{ value }}" {% if form_values.data_source == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">案例编号</label>
                            <input type="text" class="form-control" name="case_id" value="{{ form_values.case_id }}" placeholder="例如 2">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">路径数量</label>
                            <input type="number" class="form-control" name="num_paths" value="{{ form_values.num_paths }}" min="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">时间段数</label>
                            <input type="number" class="form-control" name="num_periods" value="{{ form_values.num_periods }}" min="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">价格点数量</label>
                            <input type="number" class="form-control" name="num_prices" value="{{ form_values.num_prices }}" min="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">不确定性维度</label>
                            <input type="number" class="form-control" name="uncertainty_dim" value="{{ form_values.uncertainty_dim }}" min="1">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">价格下限</label>
                            <input type="number" step="0.01" class="form-control" name="price_min" value="{{ form_values.price_min }}" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">价格上限</label>
                            <input type="number" step="0.01" class="form-control" name="price_max" value="{{ form_values.price_max }}" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">价格敏感度 a</label>
                            <input type="number" step="0.01" class="form-control" name="demand_sensitivity" value="{{ form_values.demand_sensitivity }}" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">基础需求均值</label>
                            <input type="number" step="0.01" class="form-control" name="base_mean_demand" value="{{ form_values.base_mean_demand }}" min="0">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">弧容量</label>
                            <input type="number" class="form-control" name="base_capacity" value="{{ form_values.base_capacity }}" min="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">方差比例</label>
                            <input type="number" step="0.01" class="form-control" name="uncertainty_std_ratio" value="{{ form_values.uncertainty_std_ratio }}" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">随机种子</label>
                            <input type="number" class="form-control" name="seed" value="{{ form_values.seed }}">
                        </div>
                        <div class="col-md-3 form-check form-switch align-self-end ps-4">
                            <input class="form-check-input" type="checkbox" role="switch" id="lpRelaxation" name="use_lp_relaxation" {% if form_values.use_lp_relaxation == 'on' %}checked{% endif %}>
                            <label class="form-check-label" for="lpRelaxation">LP 松弛 (仅用于确定性模型)</label>
                        </div>

                        <div class="col-12 d-flex justify-content-end">
                            <button type="submit" class="btn btn-gradient px-4 py-2">
                                <i class="bi bi-play-circle-fill me-2"></i>运行模型
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </div>
    </div>

    {% if result %}
        <div class="row justify-content-center g-4 mt-1">
            <div class="col-12 col-xl-10">
                <section class="card result-card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
                            <div>
                                <h2 class="h4 mb-1">运行结果</h2>
                                <p class="mb-0 text-muted">{{ result.message }}</p>
                            </div>
                            <div class="text-end">
                                {% if result.metrics.status %}
                                    <span class="badge status-badge">状态：{{ result.metrics.status }}</span>
                                {% endif %}
                                {% if result.objective is not none %}
                                    <div class="fs-5 fw-semibold text-primary mt-2">
                                        <i class="bi bi-bullseye me-1"></i>目标值：{{ result.objective }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row g-4">
                            <div class="col-lg-5">
                                <h3 class="h6 text-uppercase text-muted">模型指标</h3>
                                <ul class="metric-list list-unstyled mb-0">
                                    {% for key, value in result.metrics.items() %}
                                        <li>
                                            <span class="label">{{ key }}</span>
                                            <span class="value">{{ value }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="col-lg-7">
                                <h3 class="h6 text-uppercase text-muted">变量快照</h3>
                                {% if result.details %}
                                    <div class="solution-grid">
                                        {% for name, entries in result.details.items() %}
                                            <div class="solution-block">
                                                <div class="solution-title">{{ name }}</div>
                                                <ul class="mb-0">
                                                    {% for key, value in entries %}
                                                        <li><code>{{ key }}</code>：{{ value }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted small">暂无可展示的数据（可能是求解未成功或模型未返回结果）。</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    {% endif %}

    <div class="row justify-content-center g-4 mt-1">
        <div class="col-12 col-xl-10">
            <section class="card log-card border-0 shadow-sm">
                <div class="card-header border-0 bg-transparent p-4 pb-0">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-activity text-primary fs-4"></i>
                        <div>
                            <h2 class="h5 mb-1">实时终端日志</h2>
                            <p class="mb-0 text-muted small">模型运行过程中的日志将实时显示，便于排查问题与观察求解进度。</p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4 pt-3">
                    <div class="log-output" id="logStream">
                        <div class="log-placeholder text-muted small">暂无日志，请运行模型后查看。</div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>

<script>
    (() => {
        const logContainer = document.getElementById('logStream');
        if (!logContainer) return;
        const placeholder = logContainer.querySelector('.log-placeholder');
        let lastSeq = 0;
        const levelClassMap = {
            info: 'level-info',
            warning: 'level-warning',
            error: 'level-error',
            critical: 'level-critical',
            debug: 'level-debug'
        };
        const logsEndpoint = "{{ url_for('stream_logs') }}";

        function escapeHtml(text) {
            return String(text ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function renderEntries(entries) {
            if (!entries.length) {
                if (!logContainer.querySelector('.log-line') && placeholder) {
                    placeholder.classList.remove('d-none');
                }
                return;
            }
            if (placeholder) {
                placeholder.classList.add('d-none');
            }
            entries.forEach((entry) => {
                const levelKey = String(entry.level || 'info').toLowerCase();
                const logLine = document.createElement('div');
                logLine.className = `log-line ${levelClassMap[levelKey] ?? 'level-info'}`;
                logLine.innerHTML = `
                    <span class="log-time">${escapeHtml(entry.time)}</span>
                    <span class="log-level">${escapeHtml(entry.level)}</span>
                    <span class="log-message">${escapeHtml(entry.message)}</span>
                `;
                logContainer.appendChild(logLine);
            });
            logContainer.scrollTo({ top: logContainer.scrollHeight, behavior: 'smooth' });
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`${logsEndpoint}?since=${lastSeq}`, { headers: { 'Accept': 'application/json' } });
                if (!response.ok) {
                    return;
                }
                const payload = await response.json();
                renderEntries(Array.isArray(payload.entries) ? payload.entries : []);
                if (typeof payload.latest === 'number') {
                    lastSeq = payload.latest;
                }
            } catch (err) {
                console.error('无法获取日志流', err);
            }
        }

        fetchLogs();
        const timer = setInterval(fetchLogs, 1500);
        window.addEventListener('beforeunload', () => clearInterval(timer));
    })();
</script>
</body>
</html>
