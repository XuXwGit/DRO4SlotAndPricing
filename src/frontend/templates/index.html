<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>DRO 舱位定价模型可视化控制台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="container my-4">
    <h1 class="mb-3">班轮舱位分配与定价 - 可视化运行面板</h1>
    <p class="text-muted">配置模型参数，点击运行即可查看求解摘要与关键指标。</p>

    {% if errors %}
        <div class="alert alert-danger" role="alert">
            <ul class="mb-0">
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post" class="row g-3">
        <div class="col-md-4">
            <label class="form-label">模型类型</label>
            <select class="form-select" name="model_type">
                {% for value, label in model_types %}
                    <option value="{{ value }}" {% if form_values.model_type == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">数据来源</label>
            <select class="form-select" name="data_source">
                {% for value, label in data_sources %}
                    <option value="{{ value }}" {% if form_values.data_source == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">案例编号</label>
            <input type="text" class="form-control" name="case_id" value="{{ form_values.case_id }}">
        </div>

        <div class="col-md-3">
            <label class="form-label">路径数量</label>
            <input type="number" class="form-control" name="num_paths" value="{{ form_values.num_paths }}" min="1">
        </div>
        <div class="col-md-3">
            <label class="form-label">时间段数</label>
            <input type="number" class="form-control" name="num_periods" value="{{ form_values.num_periods }}" min="1">
        </div>
        <div class="col-md-3">
            <label class="form-label">价格点数量</label>
            <input type="number" class="form-control" name="num_prices" value="{{ form_values.num_prices }}" min="1">
        </div>
        <div class="col-md-3">
            <label class="form-label">不确定性维度</label>
            <input type="number" class="form-control" name="uncertainty_dim" value="{{ form_values.uncertainty_dim }}" min="1">
        </div>

        <div class="col-md-3">
            <label class="form-label">价格下限</label>
            <input type="number" step="0.01" class="form-control" name="price_min" value="{{ form_values.price_min }}" min="0">
        </div>
        <div class="col-md-3">
            <label class="form-label">价格上限</label>
            <input type="number" step="0.01" class="form-control" name="price_max" value="{{ form_values.price_max }}" min="0">
        </div>
        <div class="col-md-3">
            <label class="form-label">价格敏感度 a</label>
            <input type="number" step="0.01" class="form-control" name="demand_sensitivity" value="{{ form_values.demand_sensitivity }}" min="0">
        </div>
        <div class="col-md-3">
            <label class="form-label">基础需求均值</label>
            <input type="number" step="0.01" class="form-control" name="base_mean_demand" value="{{ form_values.base_mean_demand }}" min="0">
        </div>

        <div class="col-md-3">
            <label class="form-label">弧容量</label>
            <input type="number" class="form-control" name="base_capacity" value="{{ form_values.base_capacity }}" min="1">
        </div>
        <div class="col-md-3">
            <label class="form-label">方差比例</label>
            <input type="number" step="0.01" class="form-control" name="uncertainty_std_ratio" value="{{ form_values.uncertainty_std_ratio }}" min="0">
        </div>
        <div class="col-md-3">
            <label class="form-label">随机种子</label>
            <input type="number" class="form-control" name="seed" value="{{ form_values.seed }}">
        </div>
        <div class="col-md-3 form-check form-switch align-self-end">
            <input class="form-check-input" type="checkbox" role="switch" id="lpRelaxation" name="use_lp_relaxation" {% if form_values.use_lp_relaxation == 'on' %}checked{% endif %}>
            <label class="form-check-label" for="lpRelaxation">LP 松弛 (仅用于确定性模型)</label>
        </div>

        <div class="col-12">
            <button type="submit" class="btn btn-primary">运行模型</button>
        </div>
    </form>

    {% if result %}
        <section class="mt-4">
            <h2 class="h4">运行结果</h2>
            <div class="alert {% if result.success %}alert-success{% else %}alert-warning{% endif %}">
                {{ result.message }}
                {% if result.objective is not none %}
                    <div><strong>目标值：</strong> {{ result.objective }}</div>
                {% endif %}
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h3 class="h5">模型指标</h3>
                    <table class="table table-sm table-striped">
                        <tbody>
                        {% for key, value in result.metrics.items() %}
                            <tr>
                                <th scope="row">{{ key }}</th>
                                <td>{{ value }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <h3 class="h5">变量快照</h3>
                    {% if result.details %}
                        {% for name, entries in result.details.items() %}
                            <div class="solution-block">
                                <h4 class="h6">{{ name }}</h4>
                                <ul>
                                    {% for key, value in entries %}
                                        <li><code>{{ key }}</code>: {{ value }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">暂无可展示的数据（可能是求解未成功或模型未返回结果）。</p>
                    {% endif %}
                </div>
            </div>
        </section>
    {% endif %}
</div>
</body>
</html>
